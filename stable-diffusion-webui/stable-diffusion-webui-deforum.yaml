# yaml-language-server: $schema=../.job.schema.json
enableLogging: true

resources:
  tasks: 1
  cpusPerTask: 2
  memPerCpu: 10000
  gpus: 1

steps:
  - name: automatic111
    run:
      resources:
        gpusPerTask: 1
      container:
        registry: registry-1.deepsquare.run
        image: library/automatic111:gpu
      network: slirp4netns
      customNetworkInterfaces:
        - bore:
            boreAddress: bore.deepsquare.run:2200
            targetPort: 7860
      mapGid: 0
      mapUid: 0
      command: |
        set -e
        apt update -y
        apt install curl -y
        mv /home/app/project/stable-diffusion-webui/models /tmp/models
        mkdir -p $DEEPSQUARE_SHARED_TMP/models
        ln -s $DEEPSQUARE_SHARED_TMP/models /home/app/project/stable-diffusion-webui/models
        mv /tmp/models/* /home/app/project/stable-diffusion-webui/models || true
        cd /home/app/project/stable-diffusion-webui
        git clone https://github.com/deforum-art/sd-webui-deforum extensions/deforum
        git clone https://github.com/Mikubill/sd-webui-controlnet.git extensions/sd-webui-controlnet
        # git clone https://github.com/kabachuha/sd-webui-text2video.git extensions/sd-webui-text2video
        # . /home/app/project/stable-diffusion-webui/venv/bin/activate
        # pip install tqdm
        mkdir -p extensions/sd-webui-controlnet/models
        wget -qO extensions/sd-webui-controlnet/models/control_v11e_sd15_ip2p.pth https://huggingface.co/lllyasviel/ControlNet-v1-1/resolve/main/control_v11e_sd15_ip2p.pth
        sed -i 's/can_run_as_root=0/can_run_as_root=1/' ./webui.sh
        ./webui.sh --listen --port 7860 --enable-insecure-extension-access
